# Claude Relay

Monitor and interact with your [Claude Code](https://docs.anthropic.com/en/docs/claude-code) sessions from your iPhone — remotely, over your network.

Claude Relay runs a lightweight daemon on your Mac that discovers all your Claude Code sessions, then bridges them to a mobile app via WebSocket. You get a full terminal view with xterm.js, so you see exactly what you'd see on your Mac.

**Use cases:**
- Kick off a long Claude Code task, walk away, check progress from your phone
- Watch Claude work in real-time from the couch
- Type a quick reply or hit Enter when Claude is waiting for input
- Kill a runaway session without going back to your desk

## Screenshots

<!-- TODO: Add screenshots of the app in action -->
*Screenshots coming soon — session list, terminal view, and iPad split view.*

## How It Works

```
┌──────────┐         WebSocket / HTTP          ┌──────────────┐
│  iPhone   │ ◄──────────────────────────────► │  Mac (daemon) │
│  app      │        over your network          │  port 7860    │
└──────────┘                                   └───────┬───────┘
                                                       │
                                               tmux + node-pty
                                                       │
                                               ┌───────▼───────┐
                                               │  Claude Code   │
                                               │  CLI sessions  │
                                               └───────────────┘
```

The daemon discovers sessions from `~/.claude/projects/` JSONL files, manages tmux sessions for persistence, and bridges terminal I/O over WebSocket. The mobile app renders everything with xterm.js in a WebView.

## Prerequisites

- **macOS** (the daemon uses node-pty and launchd)
- **Node.js 22+** (`node -v` to check)
- **tmux** (`brew install tmux` if not installed)
- **Claude Code CLI** installed and used (the daemon reads its session files)

## Quick Start

### 1. Install the daemon

```bash
git clone https://github.com/A-Somniatore/claude-relay.git
cd claude-relay/daemon
npm install
npm run build
```

### 2. Run it as a persistent service

```bash
npm run install-service
```

This installs a macOS LaunchAgent that:
- Starts the daemon automatically on login
- Restarts it if it crashes (with 10s throttle)
- Logs to `~/Library/Logs/claude-relay/`

After install, you'll see your connection info:

```
  Config: ~/.config/claude-relay/config.yaml
  PSK:    <your-relay-key>

  Connect your mobile app with:
    Host: <your-mac-ip>:7860
    Key:  <your-relay-key>
```

### 3. Connect the mobile app

Open the Claude Relay app on your iPhone and enter:
- **Host:** Your Mac's IP address + port (e.g., `192.168.1.50:7860`)
- **Key:** The PSK shown during install

For remote access outside your LAN, use a VPN (Tailscale, WireGuard, etc.) or any other method that gives your phone a route to your Mac's IP.

## Service Management

```bash
# Check if the daemon is running
curl http://localhost:7860/api/status

# View logs
tail -f ~/Library/Logs/claude-relay/daemon.log

# Restart (after code update or config change)
npm run restart-service

# Stop and remove the service
npm run uninstall-service
```

### Updating

```bash
git pull
npm install
npm run build
npm run restart-service
```

### Node version managers (nvm, fnm, asdf, volta)

The install script bakes your current `node` path into the LaunchAgent. If you switch Node versions, re-run:

```bash
npm run install-service
```

## Configuration

Config lives at `~/.config/claude-relay/config.yaml` (auto-generated on first run):

```yaml
port: 7860
host: "0.0.0.0"
auth:
  psk: "<auto-generated-key>"
tmux:
  defaultCols: 120
  defaultRows: 40
  scrollbackLines: 10000
claude:
  binary: "claude"
  maxSessions: 5
projectDirs:
  - "~/projects"
```

| Key | Description | Default |
|-----|-------------|---------|
| `port` | Daemon listen port | `7860` |
| `host` | Bind address (`0.0.0.0` = all interfaces) | `0.0.0.0` |
| `auth.psk` | Pre-shared key for authentication | Random on first run |
| `tmux.defaultCols` | Default terminal width | `120` |
| `tmux.defaultRows` | Default terminal height | `40` |
| `claude.maxSessions` | Max concurrent tmux sessions | `5` |
| `projectDirs` | Directories to list in "New Session" screen | `["~/projects"]` |

After changing config, restart the daemon:

```bash
npm run restart-service
```

## Building the Mobile App

The mobile app is a React Native iOS project. You'll need:

- **Xcode 15+** (from the Mac App Store)
- **CocoaPods** (`sudo gem install cocoapods`)
- **Ruby** (macOS ships with it)

```bash
cd mobile
npm install
cd ios && pod install && cd ..
```

### Run on Simulator

```bash
npx react-native run-ios --simulator="iPhone 16"
```

### Run on Device

1. Open `mobile/ios/ClaudeRelay.xcworkspace` in Xcode
2. Select your device as the build target
3. You may need to set a development team in Signing & Capabilities
4. Build and run (Cmd+R)

On the setup screen, enter your Mac's IP and PSK. If your phone is on the same Wi-Fi as your Mac, use your Mac's local IP (e.g., `192.168.1.x:7860`).

## Development

```bash
cd daemon
npm run dev          # tsx watch mode (auto-restarts on file changes)
```

The dev server runs on the same port (7860) with pretty-printed logs.

## API

All endpoints except `/api/status` require `Authorization: Bearer <psk>`.

| Method | Path | Description |
|--------|------|-------------|
| `GET` | `/api/status` | Health check (no auth) |
| `GET` | `/api/sessions` | List all Claude sessions |
| `GET` | `/api/sessions/:id` | Session detail |
| `GET` | `/api/projects` | Sessions grouped by project |
| `POST` | `/api/sessions/:id/attach` | Attach to session (creates tmux) |
| `GET` | `/api/sessions/stream` | SSE real-time session updates |
| `POST` | `/api/sessions/:id/kill` | Kill a tmux session |
| `POST` | `/api/sessions/kill-all` | Kill all tmux sessions |
| `GET` | `/api/directories` | List project dirs for new sessions |
| `POST` | `/api/sessions/new` | Create new Claude Code session |
| `WS` | `/terminal/:sessionId` | Terminal WebSocket bridge |

## Security

- **PSK authentication** on all endpoints (timing-safe comparison)
- **Attach tokens** for WebSocket — single-use, 60s TTL, prevents bypassing session locking
- **Config file permissions** — `0o600` (owner read/write only)
- The daemon listens on all interfaces by default. For tighter security, set `host: "127.0.0.1"` and access via VPN only.

## Architecture

- **Session Discovery** — Scans `~/.claude/projects/` JSONL files with chokidar for real-time updates
- **tmux Manager** — Creates/attaches/kills tmux sessions, with session locking to prevent conflicts
- **Terminal Bridge** — node-pty spawns `tmux attach`, bridges PTY I/O to WebSocket with backpressure control
- **SSE Stream** — Pushes full session list to connected mobile clients on every discovery change

## Troubleshooting

**Daemon won't start:**
```bash
tail -20 ~/Library/Logs/claude-relay/daemon.log
tail -20 ~/Library/Logs/claude-relay/daemon.err.log
```

**Port already in use:**
```bash
lsof -i :7860
# Kill the conflicting process, then restart
npm run restart-service
```

**Mobile app can't connect:**
- Verify daemon is running: `curl http://localhost:7860/api/status`
- Check your Mac's IP: `ifconfig | grep inet`
- Ensure your phone and Mac are on the same network (or connected via VPN)
- Verify PSK matches: `grep psk ~/.config/claude-relay/config.yaml`

**No sessions showing:**
- Claude Code must have been used at least once (creates JSONL files in `~/.claude/projects/`)
- Check session count: `curl -H "Authorization: Bearer <psk>" http://localhost:7860/api/sessions | python3 -c "import sys,json; print(len(json.load(sys.stdin)))"`

## Contributing

See [CONTRIBUTING.md](CONTRIBUTING.md) for development setup and guidelines.

## License

MIT
